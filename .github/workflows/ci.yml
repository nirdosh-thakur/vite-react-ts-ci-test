# 1. Gitleaks            → secrets (fail fastest, zero cost)
# 2. OSV-Scanner         → dependency vulnerabilities (supply chain)
# 3. npm audit           → npm advisory DB (secondary SCA)
# 4. Prettier            → formatting (cheap, deterministic)
# 5. ESLint              → code quality / logic
# 6. Unit Tests          → behavior validation (optional for now)
# 7. Build               → deployability
# 8. Qodana              → deep static analysis (separate job)

name: Frontend CI Pipeline

on:
  push:
    branches-ignore:
      - dev
  pull_request:
    branches-ignore:
      - dev

permissions:
  contents: read

jobs:
  # Job - 1 : CI
  ci:
    name: Code Quality, Security & Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # -----------------------------
      # 1. Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -----------------------------
      # 2. Node setup
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      # -----------------------------
      # 3. Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------
      # 4. Gitleaks (secrets)
      # -----------------------------
      - name: Cache Gitleaks binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/gitleaks
          key: gitleaks-${{ runner.os }}-8.30.0

      - name: Install Gitleaks
        run: |
          if [ ! -f "$HOME/.local/bin/gitleaks" ]; then
            mkdir -p ~/.local/bin
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz \
              | tar -xz
            mv gitleaks ~/.local/bin/gitleaks
            chmod +x ~/.local/bin/gitleaks
          fi

      - name: Run Gitleaks Scan
        run: ~/.local/bin/gitleaks detect --no-git --redact --exit-code 1

      # -----------------------------
      # 5. Dependency vulnerabilities (OSV)
      # -----------------------------
      - name: Install OSV-Scanner
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 \
            -o osv-scanner
          chmod +x osv-scanner
          sudo mv osv-scanner /usr/local/bin/

      - name: Scan dependencies with OSV-Scanner
        run: osv-scanner scan --lockfile=package-lock.json

      # -----------------------------
      # 6. npm audit (secondary)
      # -----------------------------
      - name: Run npm audit
        run: npm audit --audit-level=high

      # -----------------------------
      # 7. Prettier (format check)
      # -----------------------------
      - name: Run Prettier check
        run: npm run format:check

      # -----------------------------
      # 8. ESLint (code quality)
      # -----------------------------
      - name: Run ESLint
        run: npm run lint

      # -----------------------------
      # 9. Build
      # -----------------------------
      - name: Build project
        run: npm run build
