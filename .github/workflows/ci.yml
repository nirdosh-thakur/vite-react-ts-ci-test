# 1. Gitleaks            → secrets
# 2. OSV-Scanner         → dependency vulnerabilities
# 3. npm audit           → npm advisory check
# 4. ESLint              → code quality
# 5. Build               → deployability
# 6. Qodana              → deep static analysis


name: Frontend CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # Job - 1 : CI
  ci:
    name: Code Quality, Security & Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:

      # 1.1 Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 0 - History, 1 - Only Current commit

      # 1.2 Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      # 1.3 Install dependencies
      - name: Install dependencies
        run: npm ci

  

      - name: Cache Gitleaks binary
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/gitleaks
          key: gitleaks-${{ runner.os }}-8.30.0

      - name: Install Gitleaks (binary)
        run: |
          if [ ! -f "$HOME/.local/bin/gitleaks" ]; then
            mkdir -p ~/.local/bin
            curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz \
              | tar -xz
            mv gitleaks ~/.local/bin/gitleaks
            chmod +x ~/.local/bin/gitleaks
          fi

      - name: Show Gitleaks Version
        run: gitleaks version

      - name: Run Gitleaks Scan (working tree only)
        run: |
          ~/.local/bin/gitleaks detect --no-git --redact --verbose --exit-code 1

      # -----------------------------
      # Dependency vulnerability scan (OSV)
      # -----------------------------
      - name: Install OSV-Scanner
        run: |
          curl -sSL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 \
            -o osv-scanner
          chmod +x osv-scanner
          sudo mv osv-scanner /usr/local/bin/

      - name: Scan dependencies with OSV-Scanner
        run: |
          osv-scanner scan \
            --lockfile=package-lock.json \
            --severity=HIGH

      # -----------------------------
      # npm audit (secondary check)
      # -----------------------------
      - name: Run npm audit (high & critical only)
        run: npm audit --audit-level=high

      # 3. ESLint (fast linting)
      - name: Run ESLint (code quality inspector)
        run: npm run lint

      # 4. Unit Tests
      #- name: Run unit tests
      #  run: npm run test -- --run

      # 5. Build validation
      - name: Build project
        run: npm run build

  # Job - 2 : Qodana
  # qodana:
  #   name: Qodana Local Scan (SARIF Upload)
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15

  #   permissions:
  #     contents: read
  #     security-events: write   # REQUIRED for Security tab

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 1

  #     - name: Run Qodana (local scan)
  #       uses: JetBrains/qodana-action@v2024.3
  #       with:
  #         upload-result: false
  #         results-dir: qodana-results

  #     - name: Upload Qodana SARIF to GitHub Security
  #       uses: github/codeql-action/upload-sarif@v3
  #       with:
  #         sarif_file: qodana-results/qodana.sarif.json
