name: Frontend CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  # Job - 1 : CI
  ci:
    name: Code Quality, Security & Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # -----------------------------
      # 1. Checkout source code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 0 - History, 1 - Only Current commit

      # -----------------------------
      # 2. Setup Node.js
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      # -----------------------------
      # 3. Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------
      # 4. Secret scanning (Gitleaks - working tree only)
      # -----------------------------
      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64.tar.gz \
          | tar -xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks (no git history)
        run: |
          gitleaks detect \
            --no-git \
            --redact \
            --exit-code 1

      # -----------------------------
      # 5. Dependency vulnerability scan
      # -----------------------------
      - name: Run npm audit (high & critical only)
        run: npm audit --audit-level=high

      # -----------------------------
      # 6. ESLint (fast linting)
      # -----------------------------
      - name: Run ESLint
        run: npm run lint

      # -----------------------------
      # 7. Unit Tests
      # -----------------------------
      - name: Run unit tests
        run: npm run test -- --run

      # -----------------------------
      # 8. Build validation
      # -----------------------------
      - name: Build project
        run: npm run build

  # Job - 2 : Qodana
  qodana:
    name: Qodana Local Scan (SARIF Upload)
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write   # REQUIRED for Security tab

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Qodana (local scan)
        uses: JetBrains/qodana-action@v2024.3
        with:
          upload-result: false
          results-dir: qodana-results

      - name: Upload Qodana SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: qodana-results/qodana.sarif.json
